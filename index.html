<!DOCTYPE html>
<html>
	<head>
		<title>Random Test Generator</title>
		<meta charset="utf-8" /> 
		<link rel="stylesheet" href="css/bootstrap.min.css"/>
		<link rel="stylesheet" href="css/fontawesome-all.css">
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/bootstrap.js"></script>
		<script src="js/papaparse.min.js"></script>
		<script src="js/handlebars.js"></script>


		<script id="test-template" type="text/x-handlebars-template">
			<div class="row">
				<div class="col-lg-12">
					<h1>{{question}}</h1>
				</div>
				{{#each option}}
					//TODO: finish looping through test options

				{{/each}}
			</div>
		</script>


		<script>
			$.PAYLOAD = new Object();
			var dataTracker = new Object();

			$(document).ready(function(){
		    $("#file").change(handleFileSelect);	

		    // event handlers
				var dropzone = $("#dz");
				dropzone.on("dragover", handleDragOver);
				dropzone.on("drop", handleFileDrop);
				dropzone.on("dragleave", handleDragLeave);
				$("#formOptions").on("submit", handleOptionsSubmit);

		  	/*  Range Input Slider */
				var slider = document.getElementById("inputPassingScore");
				var output = document.getElementById("rangeVal");
				output.innerHTML = slider.value;

				slider.oninput = function() {
				  output.innerHTML = this.value;
				}


			 });

		</script>

		<style>
			/* Styles here */

		</style>

	</head>

	<body>
					
			<div id="uploadArea" class="container">
				<div class=col-lg-12>
			    <div id="dz" onclick="dropzoneClick()" accept=".csv" class="card card-body bg-light">
			    	
			    		<h1 class="text-center font-weight-bold">
			    			<i class="fas fa-cloud-upload-alt"></i>
			    			<span id="dzText">Drop your file here (or click)</span>
			    		</h1>
			    	
			    </div>
			    <input type="file" name="file" id="file" class="d-none"/>
				</div> <!-- end dzCol -->

			</div> <!-- end uploadArea -->

			<div id="optArea" class="container d-none">
				<div class="card">
					<h1 class="card-header">Select Options</h1>
					<form id="formOptions" class="card-body">
						<div class="form-group row justify-content-center">
							<label for="inputQuestions" class="col-sm-4 col-form-label"># of Questions</label>
							<div class="col-sm-2">
								<select id="inputQuestions" class="form-control">
									<option selected>Choose...</option>
								</select>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label for="inputPassingScore" class="col-sm-4 col-form-label">Min Passing Score</label>
							<input type="range" min="50" max="100" value="75" class="form-control-range col-sm-2" id="inputPassingScore">
							<span id="rangeVal">75</span>
						</div>
						<div class="form-group row justify-content-center">
							<div class="col-sm-12 text-center">
								<button type="submit" id="btnSubmitOpts" class="btn btn-primary">Submit</button>
							</div>
						</div>
					</form>
				</div>
			</div> <!--end optArea -->

			<div id="testArea" class="container d-none">
				<div class="card">
					<h1 class="card-header text-center">						
						Please answer the following questions
					</h1>					
			
					<div id="testContent" class="card-body">

						<!-- Template fills here -->

					</div>

				</div> <!-- end card -->
			</div> <!-- end testArea -->

	</body>

	<script>

		/* most of the following functions courtesy of a CodePen project I found */

		function handleFileDrop(evt) {
		  evt.stopPropagation();
		  evt.preventDefault();

		  var files = evt.originalEvent.dataTransfer.files; 
		  console.log('Caught a File!');
		  doUpload(files[0]);
		  console.log($.PAYLOAD);
		}

		function handleDragOver(evt) {
		  evt.stopPropagation();
		  evt.preventDefault();
	 		evt.originalEvent.dataTransfer.dropEffect = "copy";

		  $("#dz").addClass("bg-dark text-white");
		  $("#dzText").text("Release to upload");

		}

		function handleDragLeave(evt) {
			// User exits hover event, return to original state
			evt.stopPropagation();
			evt.preventDefault();
			$("#dz").removeClass("bg-dark text-white");
			$("#dzText").text("Drop your file here (or click)");

		}

		function doUpload(e) { 
		  console.log('attempt');
		  Papa.parse(e, {
		    header: true,
		    skipEmptyLines: 'greedy',
		    before: function(file, inputElem){ console.log('Attempting to Parse...')},
		    error: function(err, file, inputElem, reason){ console.log(err); },
		    complete: function(results, file){
		    	$.PAYLOAD = results;	// put results into global var
		    	dispTestOpts();				// call next step (display the test options)
		    }
		  });
		}

		function dropzoneClick(evt){
			// relay click event to hidden file upload input
		  $('#file').click();
		}		 
		 
		function handleFileSelect(evt) {
		  var file = evt.target.files[0];
		  Papa.parse(file, {
		    header: true,
		    dynamicTyping: true,
		    complete: function(results) {
		      console.log(results);
		    },
		    error: function(err) {
		    	console.log(err);
		    }
		  });

		} // end dropzoneClick()
 
	  function dispTestOpts(){
	  	/* Desc: Display test options area */ 
			
			// hide uploadArea & show optionArea
			$("#uploadArea").addClass("d-none");
			$("#optArea").removeClass("d-none");

			// Populate "# of questions" drop-down
			var numQuestions = $.PAYLOAD.data.length;
			var optsToAppend = "";
			for (i=1; i < numQuestions + 1; i++){
				optsToAppend += '<option value="' + i + '">' + String(i) + '</option>';
			}
			$("#inputQuestions").append(optsToAppend);
	  }


	  function handleOptionsSubmit(evt){
	  	/* Desc: User has selected options, now generate test */
	  	
	  	//evt.originalEvent.stopPropagation();
	  	evt.originalEvent.preventDefault();

	  	// Randomize test
			var randQuestions = $("#inputQuestions option:selected").val();
			var minPassing = $("#inputPassingScore").val();
			var numQuestions = $.PAYLOAD.data.length;

			// format of dataTracker obj: {idxOfQuestion: userSelection}
			for (var i=0; i < numQuestions; i++){
				//TODO: init dataTracker obj with randomized selection of question indices
			}

	  	// TODO: run template


	  	// hide optionArea and show test area
	  	$("#optArea").addClass("d-none");
	  	$("#testArea").removeClass("d-none");



	  }



	</script>



</html>