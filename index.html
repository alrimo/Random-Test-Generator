<!DOCTYPE html>
<html>
	<head>
		<title>Random Test Generator</title>
		<meta charset="utf-8" /> 
		<link rel="stylesheet" href="css/bootstrap.min.css"/>
		<link rel="stylesheet" href="css/fontawesome-all.css">
		<link rel="stylesheet" href="css/index.css">
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/bootstrap.js"></script>
		<script src="js/papaparse.min.js"></script>
		<script src="js/handlebars.js"></script>
		<script src="js/index.js"></script>


		<script id="test-template" type="text/x-handlebars-template">
			{{!-- if-statement keeps empty options from rendering --}}

			<div class="row">
				<div class="col-lg-12 question">{{question}}</div>
			</div>
			<div class="radioContainer">
				<div class="button-wrap">
					{{#if opt1}}
						<input class="hidden radio-label" type="radio" name="radio-answer" id="opt1" value="1">
						<label class="button-label" for="opt1">{{opt1}}</label>
					{{/if}}
					{{#if opt2}}
						<input class="hidden radio-label" type="radio" name="radio-answer" id="opt2" value="2">
						<label class="button-label" for="opt2">{{opt2}}</label>
					{{/if}}
					{{#if opt3}}
						<input class="hidden radio-label" type="radio" name="radio-answer" id="opt3" value="3">
						<label class="button-label" for="opt3">{{opt3}}</label>
					{{/if}}
					{{#if opt4}}
						<input class="hidden radio-label" type="radio" name="radio-answer" id="opt4" value="4">
						<label class="button-label" for="opt4">{{opt4}}</label>
					{{/if}}
					{{#if opt5}}
						<input class="hidden radio-label" type="radio" name="radio-answer" id="opt5" value="5">
						<label class="button-label" for="opt5">{{opt5}}</label>
					{{/if}}
					{{#if opt1}}
						<input class="hidden radio-label" type="radio" name="radio-answer" id="opt6" value="6">
						<label class="button-label" for="opt6">{{opt6}}</label>
					{{/if}}					
				</div>
			</div>
		</script>

		<script>
			// Script
		</script>

		<style>
			// Styles
		</style>

	</head>

	<body>
					
		<section id="uploadArea" class="container">
			<div class=col-lg-12>
		    <div id="dz" onclick="dropzoneClick()" accept=".csv,.txt" class="card card-body bg-light">		    
	    		<h1 class="text-center font-weight-bold">
	    			<i class="fas fa-cloud-upload-alt"></i>
	    			<span id="dzText">Drop your file here (or click)</span>
	    		</h1>	    	
		    </div>
		    <input type="file" name="file" id="file" class="d-none"/>
			</div> <!-- end dzCol -->

			<div id="test">
				<h3>Pre-built MQFs</h3>
				<button class="btn btn-primary" onClick="doUpload('tests/test-data.csv', true)">C-130</button>
			</div>

			<div class="row justify-content-center">
				<header class="col-lg-10">
					<h2>Instructions</h2>
				</header>
				<div class="col-lg-8">
					<ul>
						<li>Questions must be input into specially-formatted CSV file</li>
						<li>The file name must end in ".csv"
						<li>The file must be <em>tab-delimited</em> and use specific header names (without quotes):</li>
						<ul>
							<li>"question" - The actual question</li>
							<li>"opt1" - multiple-choice option 1-6 (blank is okay)</li>
							<li>"opt2"</li>
							<li>"opt3"</li>
							<li>"opt4"</li>
							<li>"opt5"</li>
							<li>"opt6"</li>
							<li>"ans" - number of the correct answer</li>
						</ul>
						<li>Download the <a href="template/template.csv">template</a></li>
					</ul>
				</div>
			</div>

		</section> <!-- end uploadArea -->

		<section id="optArea" class="container d-none mt-5">
			<div class="card">
				<h1 class="card-header">Select Options</h1>
				<form id="formOptions" class="card-body">
					<div class="form-group row justify-content-center">
						<label for="inputQuestions" class="col-sm-4 col-form-label"># of Questions</label>
						<div class="col-sm-2">
							<select id="inputQuestions" class="form-control">
								<option selected>Choose...</option>
							</select>
						</div>
					</div>
					<div class="form-group row justify-content-center">
						<label for="inputPassingScore" class="col-sm-4 col-form-label">Min Passing Score</label>
						<input type="range" min="50" max="100" value="75" class="form-control-range col-sm-2" id="inputPassingScore">
						<span id="rangeVal">75</span>
					</div>
					<div class="form-group row justify-content-center">
						<div class="col-sm-12 text-center">
							<button type="submit" id="btnSubmitOpts" class="btn btn-primary">Submit</button>
						</div>
					</div>
				</form>
			</div>
		</section> <!--end optArea -->

		<!-- Test Display Area -->
		<div id="testArea" class="row justify-content-center d-none">
			<div class="card col-lg-6 p-0 mt-5">
				<h1 class="card-header text-center">						
					Please answer the following questions
				</h1>					
		
				<div id="testContent" class="card-body">

					<div id="testContentQuestion">
						<!-- Question Template fills here -->						
					</div>

					<nav>
						<ul class="pagination">
							<li id="prevPage" class="page-item disabled">
								<a class="page-link" href="#" tabindex="-1">Prev</a>
							</li>
							<li id="currPage" class="page-item"><span class="page-link">1</span></li>
					    <li id="nextPage" class="page-item">
					      <a class="page-link" href="#">Next</a>
					    </li>
						</ul>
					</nav>
					<div>
						<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalSubmit">Finish Test</button>
					</div>
				</div> <!-- END card-body -->
			</div> <!-- end card -->
		</div> <!-- end testArea -->

		<!-- Results -->
		<div id="resultsArea" class="d-none row justify-content-center">			
			<section class="col-lg-6">
				<h3 id="resultBanner" class="card-header">--Result Placeholder--</h3>
				<div class="card-body">
					<h3>Your score:</h3>
					<h4 id="resultScore">--score placeholder--</h4>
				</div>
				<button id="btnRetake" type="button" class="btn btn-secondary" disabled>Re-Take</button>
				<button id="btnGenNew" type="button" class="btn btn-primary" disabled>Generate New</button>
			</section>

			
		</div> <!-- END resultsArea -->

		<!-- Confirmation Modal -->
		<div id="modalSubmit" class="modal fade" role="dialog" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
		        <h5 class="modal-title" id="exampleModalLabel">Confirm</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
					<div class="modal-body">
						<h3>Do you wish to submit your test?</h3>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" id="btnFinish">Yes, Submit</button>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</div>	
			</div>
		</div> <!-- END confirmation modal -->

	</body>



	<script>

		/* most of the following functions courtesy of a CodePen project I found */

		function handleFileDrop(evt) {
		  evt.stopPropagation();
		  evt.preventDefault();

		  var files = evt.originalEvent.dataTransfer.files; 
		  console.log('Caught a File!');
		  doUpload(files[0]);
		  console.log($.PAYLOAD);
		}

		function handleDragOver(evt) {
		  evt.stopPropagation();
		  evt.preventDefault();
	 		evt.originalEvent.dataTransfer.dropEffect = "copy";

		  $("#dz").addClass("bg-dark text-white");
		  $("#dzText").text("Release to upload");

		}

		function handleDragLeave(evt) {
			// User exits hover event, return to original state
			evt.stopPropagation();
			evt.preventDefault();
			$("#dz").removeClass("bg-dark text-white");
			$("#dzText").text("Drop your file here (or click)");

		}

		function doUpload(e, download = false) { 
		  console.log('attempt');
		  Papa.parse(e, {
		    header: true,
		    download: download,
		    delimiter: "\t",
		    skipEmptyLines: 'greedy',
		    before: function(file, inputElem){ console.log('Attempting to Parse...')},
		    error: function(err, file, inputElem, reason){ console.log(err); },
		    complete: function(results, file){
		    	$.PAYLOAD = results;	// put results into global var
		    	dispTestOpts();				// call next step (display the test options)
		    }
		  });
		}

		function dropzoneClick(evt){
			// relay click event to hidden file upload input
		  $('#file').click();
		}		 
		 
		function handleFileSelect(evt) {
		  var file = evt.target.files[0];
		  Papa.parse(file, {
		    header: true,
		    dynamicTyping: true,
		    complete: function(results) {
		      console.log(results);
		    },
		    error: function(err) {
		    	console.log(err);
		    }
		  });

		} // end dropzoneClick()
 
	  function dispTestOpts(){
	  	/* Desc: Display test options area */ 
			
			// hide uploadArea & show optionArea
			$("#uploadArea").addClass("d-none");
			$("#optArea").removeClass("d-none");

			// Populate "# of questions" drop-down
			var numQuestions = $.PAYLOAD.data.length;
			var optsToAppend = "";
			for (i=1; i < numQuestions + 1; i++){
				optsToAppend += '<option value="' + i + '">' + String(i) + '</option>';
			}
			$("#inputQuestions").append(optsToAppend);
	  }


		function shuffleArray(array) {
	    /* Durstenfeld shuffle algorithm */
	    for (var i = array.length - 1; i > 0; i--) {
	        var j = Math.floor(Math.random() * (i + 1));
	        var temp = array[i];
	        array[i] = array[j];
	        array[j] = temp;
	    }
		}

	  function handleOptionsSubmit(evt){
	  	/* Desc: User has selected options, now generate test */
	  	
	  	//evt.originalEvent.stopPropagation();
	  	evt.originalEvent.preventDefault();

	  	// Randomize test
			var randQuestions = $("#inputQuestions option:selected").val();
			minPassing = $("#inputPassingScore").val();
			var numQuestions = $.PAYLOAD.data.length;

			/* Generate randomized test number array
				Approach: (1) Create a simple array numbered 1 to total # of questions in CSV
									(2) Shuffle that array
									(3) Truncate array to # of question user selected
				End State: 	randomized indices of user-specified length.  
										In other words: x random questions selected from y total questions  
			*/
			
			for(let i = 0; i < numQuestions; i++){				
				questionList.push(i);
			}
			shuffleArray(questionList);							
			questionList.length = randQuestions;		// truncate array to user-specified number of questions 

			// init dataTracker obj
			for (let i=0; i < questionList.length; i++){
				dataTracker[i] = -1;
			}

			// init pagination
			paginateInit();

			// render first question
			displayQuestion(0);

			// calculate minimum passing score


	  	// hide optionArea and show test area
	  	$("#optArea").addClass("d-none");
	  	$("#testArea").removeClass("d-none");

	  }

	  function displayQuestion(questionIdx){
	  	/* Desc: Use handlebars.js to render specified question into template area */

	  	// Get question from question bank (i.e., $.PAYLOAD)
	  	var randQ = questionList[questionIdx]
	  	var context = $.PAYLOAD.data[randQ];

	  	// Render template (via handlebars.js)
	  	var source = document.getElementById("test-template").innerHTML;
	  	var template = Handlebars.compile(source);
	  	var html = template(context);
	  	$("#testContentQuestion").html(html);

	  	// (re)wire up event handler(s) on each render
	  	$("input[type=radio][name='radio-answer'").on("change", handleRadioChange);

  		// re-select question if user already picked one
  		var userSelectedNum = dataTracker[questionIdx];
  		if(userSelectedNum != -1) {
  			var jQStr = "input[name='radio-answer'][value='" + userSelectedNum + "']";
  			$(jQStr).prop('checked', true);
  		}

	  }



	  /****** Pagination *******/

	  function paginateInit(){
			currentQ = 0;
			nextQ = 1;
			prevQ = -1;
			lastQ = questionList.length;
			updatePaginate();
	  }

	  function updatePaginate() {
	  	/* Desc: update pagination buttons on page */
	  	
	  	$("#currPage > span").text(currentQ + 1);

	  	// Disable/enable next button 
	  	var np = $("#nextPage");
	  	if (nextQ == -1){
	  		np.addClass("disabled");
	  		np.prop("selectedIndex", -1);
	  	} else if (nextQ != -1 && np.prop("selectedIndex") == -1){
	  		// next question shouldn't be disable but still is
	  		np.prop("selectedIndex", 0);
	  		np.removeClass("disabled");
	  	}

	  	// Disable/enable prev button

	  	var pp = $("#prevPage");
	  	if (prevQ == -1){
	  		pp.addClass("disabled");
	  		pp.prop("selectedIndex", -1);
	  	} else if (prevQ != -1 && pp.prop("selectedIndex") == -1){
	  		pp.prop("selectedIndex", 0);
	  		pp.removeClass("disabled");
	  	}
	  }

	  function paginateNext(){
	  	// update to next only if one exists
	  	if( currentQ + 1 <= (questionList.length - 1) ){
	  		/* update trackers: 
	  					'previous' quesion is current
	  					'current' is next
	  					'next' is next-next (+2 from current, if exists)
				*/
	  		prevQ = currentQ;
	  		nextQ = (currentQ + 2 <= (questionList.length -1)) ? nextQ + 2 : -1; 
	  		currentQ = currentQ + 1;

	  		//update pagination
	  		updatePaginate();

	  		// render new question
	  		displayQuestion(currentQ);

	  	} else {
	  		console.log("Unable to go to next question: at end of list");
	  		console.log("currentQ: ", currentQ);
	  		console.log("questionList.length: ", questionList.length);
	  	}
	  }

	  function paginatePrev(){
	  	if(currentQ > 0){
	  		nextQ = currentQ;
	  		prevQ = (currentQ > 1) ? currentQ - 2 : -1;
	  		currentQ = currentQ - 1;

	  		// update pagination
	  		updatePaginate();

	  		//render new question
	  		displayQuestion(currentQ);
	  	}

	  }

	  function paginateJumpto(){
	  	/* Desc: Jumpt to a specific question */
	  	// TODO: implement pagination 
	  	x = 0;

	  }

	  /***** Test events *****/
	  function handleRadioChange(evt){
	  	/* Desc: Record user's selected answer whenever they click an option */

	  	// Get the radio button's value
			var selAnswer = this.value;

			// Record into answer tracker
			dataTracker[currentQ] = selAnswer;

	  }

	  function handleFinishTest(){
	  	/* Desc: User has finished test and is submitting for grading */
	  	x=0;

	  	// Hide Modal
	  	$("#modalSubmit").modal('hide');

	  	// Hide Test area
	  	$("#testArea").addClass("d-none");


	  	// Grade test and plug into results page
	  	var totQuestions = questionList.length;
	  	var numCorrect = 0;	// counter of correct questions
	  	
	  	// loop through answers, adding to numCorrect
	  	for (var key in dataTracker) {
	  		if(dataTracker.hasOwnProperty(key)){
	  			if(dataTracker[key] == $.PAYLOAD.data[key].ans){
	  				numCorrect += 1;
	  			}
	  		}
	  	}

	  	// calculate grade, compare to minimum passing
	  	var percentage = Math.floor((numCorrect / totQuestions) * 100);
	  	var pass = percentage >= minPassing;

	  	// construct result
	  	var bannerText = 	pass 
	  										? "Congratuations, you passed!" 
	  										: "Sorry, you did not pass!";
	  	$("#resultBanner").text(bannerText);
	  	$("#resultScore").text(String(percentage) + "%");
	  	
	  	// Display results
	  	$("#resultsArea").removeClass("d-none")

	  }


	</script>



</html>